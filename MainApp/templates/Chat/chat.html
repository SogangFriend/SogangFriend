{% extends 'base.html' %}
{% load static %}
{% block content %}
<link href="{% static '/css/chat.css' %}" rel="stylesheet">

<div class="container">
    <h3 class=" text-left"> 채팅</h3>
    <div class="messaging">
      <div class="inbox_msg">
        <div class="inbox_people">
{#          <div class="headind_srch">#}
{#            <div class="recent_heading">#}
{#              <h4>1 : 1</h4>#}
{#            </div>#}
{#            <div class="srch_bar">#}
{#              <div class="stylish-input-group">#}
{#                <input type="text" class="search-bar"  placeholder="Search" >#}
{#                <span class="input-group-addon">#}
{#                <button type="button"> <i class="fa fa-search" aria-hidden="true"></i> </button>#}
{#                </span> </div>#}
{#            </div>#}
{#          </div>#}
          <div class="inbox_chat">
          {% for room in rooms %}
            <div class="chat_list" id="chat_list_{{ room.chat_room.pk }}" style="cursor: pointer" onclick="chatRoom(this, {{ room.chat_room.pk }}, '{{ member_pk }}')">
                <div class="chat_people">
                    <div class="chat_img"> <img src="{% static '/images/default_profile.png' %}" alt="sogang"> </div>
                    <div class="chat_ib">
                        {% if room.chat_room.is_dm %}
                            <h5>{{ room.chat_room.target.name }}<span class="chat_date">{{ room.chat_room.timestamp }}</span></h5>
                        {% else %}
                            <h5>{{ room.chat_room.name }}<span class="chat_date">{{ room.chat_room.timestamp }}</span></h5>
                            <p class="people_info_txt">
                                <br>
                                인원 : {{ room.chat_room.participants.count }}명
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
          {% endfor %}
        </div>
        </div>
        <div class="mesgs">
          <div class="msg_history" id="chat-box">
          </div>
          <div class="type_msg">
            <div class="input_msg_write">
              <input type="text" id="write_msg" class="write_msg" placeholder="메시지 입력" />
              <button id="msg_send_btn" class="msg_send_btn" type="button"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

<script>
let rms = [
    {% for room in rooms %}
    {
        pk: {{ room.chat_room.pk }},
        msgs: [
            {% for msg in room.chat_room.message_set.all %}
                {
                    sender: "{{ msg.sender.pk }}",
                    senderName: "{{ msg.sender.name }}",
                    message: "{{ msg.message }}",
                    timestamp: "{{ msg.timestamp }}"
                },
            {% endfor %}
        ]
    },
    {% endfor %}
];

window.onload = () => {
    let defaultChat = sessionStorage.getItem('default');
    if ("{{ request.session.default }}" !== "") defaultChat = "{{ request.session.default }}";
    let target;
    if (defaultChat != null) {
        let id = "chat_list_" + defaultChat;
        target = document.getElementById(id);
        sessionStorage.removeItem('default');
        target.click();
    } else {
        target = chatList[0];
        target.click();
    }
};

</script>
<script src="{% static '/js/chat.js' %}"></script>
{% endblock %}