{% extends 'yellow_base.html' %}
{% load static %}
{% block inwrap %}
<link rel="stylesheet" href="{% static '/css/register.css' %}">

<div class="white_box">
    <div class="img_register_box">
        <img class="img_register" src="{% static 'images/register.jpg' %}" >
    </div>
    <div class="register">
        <span class="register_h2">
            언택트 시대,<br>친구 어떻게 사귀세요?
        </span>
        <form method = "POST" action = "" id="register-form">
            {% csrf_token %}
            <div class="form-group">
                <br>
                <div class="register_h4">
                    *표시는 필수 사항입니다.
                </div>
                <div class="idForm">
                    <input type="text" class="name_input" id="name_input" placeholder="*닉네임" name="name" check_result="fail" required />
                    <input type="button" class="name_btn" id="name_btn" onclick="name_overlap_check()" value ="중복검사"/>
                </div>

                <div class="idForm">
                    <input type="number" class="input" id="student_number" placeholder="학번을 입력하면 공개됩니다" name= "student_number">
                </div>

                <div class="idForm">
                    <input type="text" class="input" id="email" placeholder="*서강 이메일" name= "email">
                </div>

                <div class="idForm">
                    <input type="text" class="sinput" id="location" placeholder="*위치를 인증해주세요" name= "location"/>
                    <input type="button" class="sbtn" onclick="coordToAddr()" value="위치 얻기"/>
                </div>

                <div class="idForm">
                    <input type="password" class="input" id="password" placeholder="*비밀번호 (7자 이상 영문자&숫자 조합)" name= "password">
                </div>

                <div class="idForm">
                    <input type= "password" class="input" id="re_password" placeholder="*비밀번호 확인" name = "re_password">
                </div>

                <div class="idForm">
                    <input type="text" class="input" id="introduction" placeholder="간단한 자기소개를 입력해주세요" name= "introduction">
                </div>

                <div class="register_h4">
                    자기소개는 My Page에서 수정 가능합니다.
                </div>
                <br>
                <button id="alertStart" type="button" class="btn" onclick="clicked()">이메일 인증하고 가입 완료</button>

                <div class="bottomText">
                    이미 회원이신가요? <a href="{% url 'login'%}">  로그인하기</a>
                </div>
            </div>
        </form>
    </div>
</div>


<script>
    function name_overlap_check() {
        let nameInput = $('#name_input');
        nameInput.change(function () {
          $('#name_btn').show();
          $('#name_input').attr("check_result", "fail");
        })


        if (nameInput.val() === '') {
          alert('닉네임을 입력해주세요.')
          return;
        }

        let name_overlap_input = document.querySelector('input[name="name"]');

        console.log(nameInput.value);
        console.log(name_overlap_input.value);

        $.ajax({
            url: "{% url 'Member:check' %}",
            data: {
                'name': name_overlap_input.value
            },
            datatype: 'json',
            success: function (data) {
                console.log(data['overlap']);
                if (data['overlap'] === "fail") {
                    alert("이미 존재하는 닉네임 입니다.");
                    name_overlap_input.focus();
                } else {
                    alert("사용가능한 닉네임 입니다.");
                    $('#name_input').attr("check_result", "success");
                    $('#name_btn').show();
                }
            }
        });
    }

    let geocoder = new kakao.maps.services.Geocoder();
    let lat, lng;
    function coordToAddr() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                lat = position.coords.latitude;
                lng = position.coords.longitude;
                geocoder.coord2RegionCode(lng, lat, function (result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        console.log(result);
                        let addr = result[1].address_name.split(' ');
                        {#let GY = ["인천", "부산", "대전", "울산", "광주", "대구"];#}
                        {#if (addr[0] === "서울") addr[0] += "특별시";#}
                        {#else if (addr[0] === "세종") addr[0] += "특별자치시";#}
                        {#else if (addr[0] in GY) addr[0] += "광역시";#}
                        {#else addr[0] += "도";#}
                        addr = addr[0] + " " + addr[1] + " " + addr[2];
                        console.log(addr);
                        document.getElementById("location").value = addr;
                        document.getElementById("location").readOnly = true;
                    }
                });
            }, function (error) {
                console.error(error);
            }, {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: Infinity
            });
        } else {
            alert('GPS NOT SUPPORTED');
        }
    }

    function clicked () {
        let form = $('#register-form')[0];
        let formData = new FormData(form);
        console.log(formData['']);
        $.ajax({
            url: "/member/new/",
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            dataType: 'json',
        })
        .done((data) => {
            console.log(data);
            if (data['success'] === 0) {
                Swal.fire({
                    icon: 'success',
                    html: data['message'],
                    buttonsStyling:false,
                    confirmButtonText: "확인",
                    width: '672px',

                    customClass : {
                        confirmButton: 'swal-register-btn',
                        popup: 'swal-custom-container'
                    },
                    footer: data['footer']
                });
            }
            else {
                if (data['success'] === 1) {
                    Swal.fire({
                        icon: 'error',
                        html: data['message'],
                        buttonsStyling:false,
                        confirmButtonText: "확인",
                        width: '672px',

                        customClass : {
                            confirmButton: 'swal-register-btn',
                            popup: 'swal-custom-container'
                        },
                        footer: data['footer']
                    });
                }
                else {
                    Swal.fire({
                        icon: 'error',
                        html: data['message'],
                        buttonsStyling:false,
                        confirmButtonText: "로그인하러 가기",
                        cancelButtonText: "비밀번호 찾기",
                        width: '672px',
                        customClass : {
                            confirmButton: 'swal-register-btn',
                            cancelButton: 'swal-register-cancel-btn',
                            popup: 'swal-custom-container',
                        },
                        footer: data['footer']
                    })
                    .then((result) => {
                        if(result.isConfirmed){
                            window.location = "/login/";
                        } else {
                            $.ajax({
                                url: "/member/password/",
                                method: "GET",
                            })
                        }
                    });
                }
            }

        })
        .fail(() => {console.log("failed");});
    }
    </script>
{% endblock %}
