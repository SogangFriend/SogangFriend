{% extends 'yellow_base.html' %}
{% load static %}
{% block inwrap %}
    <img class="img" src="{% static 'images/register.jpg' %}" >
    <link rel="stylesheet" href="{% static '/css/register.css' %}">

    <div class="register">
        <h2>회원가입하고</h2>
        <h2>인생친구 만들어 볼까요?</h2>
        {% if error %}
            <script type="text/javascript">
                alert("{{ error }}");
            </script>
        {% endif %}
        <div class = "col-12 ">
            <form method = "POST" action = "" id="register-form">
                {% csrf_token %}
                <div class="form-group">
                    <div class="idForm">
                    </div>
                    <br> <br> <br> <br>
                    <h4>*표시는 필수 사항입니다.</h4>

                    <div class="idForm">
                        <input type="text" class="inputshort" id="name" placeholder="*닉네임" name="name">
                        <input type="button" class="btn1" onclick="id_overlap_check()" value ="중복검사"/>
                    </div>

                    <div class="idForm">
                        <input type="number" class="input" id="student_number" placeholder="학번을 입력하면 공개됩니다" name= "student_number">
                    </div>

                    <div class="idForm">
                        <input type="text" class="input" id="email" placeholder="*서강 이메일" name= "email">
                    </div>

                    <div class="idForm">
                        <input type="text" class="inputshort" id="location" placeholder="*위치를 인증해주세요" name= "location"/>
                        <input type="button" class="btn1" onclick="coordToAddr()" value="위치 얻기"/>
                    </div>

                    <div class="idForm">
                        <input type="password" class="input" id="password" placeholder="*비밀번호 (7자 이상 영문자&숫자 조합)" name= "password">
                    </div>

                    <div class="idForm">
                        <input type= "password" class="input" id="re_password" placeholder="*비밀번호 확인" name = "re_password">
                    </div>

                    <div class="idForm">
                        <input type="text" class="input" id="introduction" placeholder="간단한 자기소개를 입력해주세요" name= "introduction">
                    </div>
                    <h4>자기소개는 My Page에서 수정 가능합니다. </h4>

                    <input id="alertStart" type="button" class="btn" onclick="clicked()" value="이메일 인증하고 가입 완료"/>

                    <div class="bottomText text-center">
                        이미 회원이신가요? <a href="{% url 'login'%}"> 로그인하기 </a>

                    </div>
                </div>
           </form>
        </div>
    </div>


    <script>

    let geocoder = new kakao.maps.services.Geocoder();
    let lat, lng;
        function coordToAddr() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    lat = position.coords.latitude;
                    lng = position.coords.longitude;
                    geocoder.coord2Address(lng, lat, function (result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            console.log(result);
                            let addr = result[0].address.address_name.split(' ');
                            let GY = ["인천", "부산", "대전", "울산", "광주", "대구"];
                            if (addr[0] === "서울") addr[0] += "특별시";
                            else if (addr[0] === "세종") addr[0] += "특별자치시";
                            else if (addr[0] in GY) addr[0] += "광역시";
                            else addr[0] += "도";
                            addr = addr[0] + " " + addr[1] + " " + addr[2];
                            console.log(addr);
                            document.getElementById("location").value = addr;
                        }
                    });
                }, function (error) {
                    console.error(error);
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: Infinity
                });
            } else {
                alert('GPS NOT SUPPORTED');
            }
        }

        function clicked () {
            let form = $('#register-form')[0];
            let formData = new FormData(form);
            $.ajax({
                url: "/member/new/",
                method: "POST",
                data: formData,
                processData: false,
			    contentType: false,
                dataType: 'json',
            })
            .done((data) => {
                console.log(data);
                if (data['success'] === 0) {
                    Swal.fire({
                        icon: 'success',
                        html: data['message'],
                        buttonsStyling:false,
                        confirmButtonText: "확인",
                        width: '672px',

                        customClass : {
                            confirmButton: 'swal-register-btn',
                            popup: 'swal-custom-container'
                        },
                        footer: data['footer']
                    });
                }
                else {
                    if (data['success'] === 1) {
                        Swal.fire({
                            icon: 'error',
                            html: data['message'],
                            buttonsStyling:false,
                            confirmButtonText: "확인",
                            width: '672px',

                            customClass : {
                                confirmButton: 'swal-register-btn',
                                popup: 'swal-custom-container'
                            },
                            footer: data['footer']
                        });
                    }
                    else {
                        Swal.fire({
                            icon: 'error',
                            html: data['message'],
                            buttonsStyling:false,
                            confirmButtonText: "로그인하러 가기",
                            cancelButtonText: "비밀번호 찾기",
                            width: '672px',
                            customClass : {
                                confirmButton: 'swal-register-btn',
                                cancelButton: 'swal-register-cancel-btn',
                                popup: 'swal-custom-container',
                            },
                            footer: data['footer']
                        })
                        .then((result) => {
                            if(result.isConfirmed){
                                window.location = "/login/";
                            } else {
                                $.ajax({
                                    url: "/member/password/",
                                    method: "GET",
                                })
                            }
                        });
                    }
                }

            })
            .fail(() => {console.log("failed");});
        }
    </script>
{% endblock %}
